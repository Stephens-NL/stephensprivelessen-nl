<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Notes Dashboard - Stephen's Privelessen</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f8fafc;
            color: #1a202c;
            line-height: 1.6;
        }
        
        .app-container {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        /* Header */
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 2rem 1.5rem;
            text-align: center;
            position: relative;
        }
        
        .header h1 {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
            text-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
            margin-bottom: 1.5rem;
        }
        
        .language-toggle {
            position: absolute;
            top: 1.5rem;
            right: 1.5rem;
            display: flex;
            gap: 0.5rem;
        }
        
        .lang-btn {
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 1.5rem;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 600;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }
        
        .lang-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            border-color: rgba(255, 255, 255, 0.5);
        }
        
        .lang-btn.active {
            background: rgba(255, 255, 255, 0.95);
            color: #667eea;
            border-color: white;
        }
        
        /* Main Content */
        .main-content {
            flex: 1;
            padding: 2rem 1.5rem;
            max-width: 1200px;
            margin: 0 auto;
            width: 100%;
        }
        
        /* Search Section */
        .search-section {
            background: white;
            border-radius: 1rem;
            padding: 2rem;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            margin-bottom: 2rem;
            border: 1px solid #e2e8f0;
        }
        
        .search-box {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }
        
        .search-input {
            flex: 1;
            padding: 1rem 1.5rem;
            border: 2px solid #e2e8f0;
            border-radius: 0.75rem;
            font-size: 1.1rem;
            transition: all 0.3s ease;
            background: #f8fafc;
        }
        
        .search-input:focus {
            outline: none;
            border-color: #667eea;
            background: white;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .search-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 1rem 2rem;
            border-radius: 0.75rem;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }
        
        .search-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }
        
        .search-btn:disabled {
            background: #94a3b8;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        /* Loading States */
        .loading {
            text-align: center;
            padding: 3rem;
        }
        
        .spinner {
            width: 3rem;
            height: 3rem;
            border: 4px solid #e2e8f0;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 1.5rem;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .error {
            background: #fef2f2;
            color: #dc2626;
            padding: 1rem;
            border-radius: 0.75rem;
            border: 1px solid #fecaca;
            text-align: center;
            margin: 1rem 0;
        }
        
        .no-results {
            text-align: center;
            padding: 3rem;
            color: #64748b;
        }
        
        .no-results h3 {
            color: #334155;
            margin-bottom: 0.5rem;
            font-size: 1.5rem;
        }
        
        /* Stats */
        .stats {
            background: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%);
            padding: 1rem;
            border-radius: 0.75rem;
            text-align: center;
            margin-bottom: 1.5rem;
            font-weight: 600;
            color: #475569;
            border: 1px solid #cbd5e1;
        }
        
        /* Student Cards */
        .student-card {
            background: white;
            border-radius: 1rem;
            padding: 1.5rem;
            margin-bottom: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
            border: 1px solid #e2e8f0;
        }
        
        .student-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.12);
            border-color: #667eea;
        }
        
        .student-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }
        
        .student-name {
            font-size: 1.4rem;
            font-weight: 700;
            color: #1e293b;
        }
        
        .subject-badge {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 1.5rem;
            font-size: 0.85rem;
            font-weight: 600;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
        }
        
        .student-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }
        
        .last-activity {
            color: #64748b;
            font-size: 0.95rem;
        }
        
        .file-count {
            background: #f1f5f9;
            color: #475569;
            padding: 0.25rem 0.75rem;
            border-radius: 1rem;
            font-size: 0.8rem;
            font-weight: 600;
            border: 1px solid #cbd5e1;
        }
        
        .click-hint {
            text-align: center;
            color: #667eea;
            font-size: 0.9rem;
            font-weight: 600;
            margin-top: 0.5rem;
        }
        
        /* Featured Note Section */
        .featured-note {
            background: white;
            border-radius: 1rem;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            border: 1px solid #e2e8f0;
        }
        
        .featured-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid #f1f5f9;
        }
        
        .featured-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: #1e293b;
        }
        
        .featured-subject {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 1.5rem;
            font-size: 0.85rem;
            font-weight: 600;
        }
        
        .featured-content {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 2rem;
            align-items: start;
        }
        
        .featured-preview {
            background: #f8fafc;
            border-radius: 0.75rem;
            padding: 1.5rem;
            text-align: center;
            border: 2px solid #e2e8f0;
        }
        
        .featured-preview img {
            max-width: 100%;
            height: auto;
            border-radius: 0.5rem;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .featured-details {
            padding: 1rem 0;
        }
        
        .featured-summary {
            background: #f8fafc;
            padding: 1.5rem;
            border-radius: 0.75rem;
            margin-bottom: 1.5rem;
            border-left: 4px solid #667eea;
        }
        
        .featured-summary h4 {
            color: #1e293b;
            margin-bottom: 0.5rem;
            font-size: 1.1rem;
        }
        
        .featured-summary p {
            color: #64748b;
            line-height: 1.6;
        }
        
        .featured-meta {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }
        
        .meta-item {
            background: #f1f5f9;
            padding: 1rem;
            border-radius: 0.5rem;
            text-align: center;
            border: 1px solid #e2e8f0;
        }
        
        .meta-label {
            font-size: 0.8rem;
            color: #64748b;
            margin-bottom: 0.25rem;
            font-weight: 600;
        }
        
        .meta-value {
            font-size: 1rem;
            color: #1e293b;
            font-weight: 700;
        }
        
        .featured-actions {
            display: flex;
            gap: 1rem;
        }
        
        .action-btn {
            flex: 1;
            padding: 1rem 1.5rem;
            border: none;
            border-radius: 0.75rem;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            text-align: center;
            display: inline-block;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }
        
        .btn-secondary {
            background: white;
            color: #667eea;
            border: 2px solid #667eea;
        }
        
        .btn-secondary:hover {
            background: #667eea;
            color: white;
        }
        
        /* Files Section */
        .files-section {
            background: white;
            border-radius: 1rem;
            padding: 2rem;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            border: 1px solid #e2e8f0;
        }
        
        .files-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid #f1f5f9;
        }
        
        .files-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: #1e293b;
        }
        
        .filters-section {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
            align-items: center;
        }
        
        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        
        .filter-label {
            font-size: 0.9rem;
            font-weight: 600;
            color: #475569;
        }
        
        .filter-select {
            padding: 0.75rem 1rem;
            border: 2px solid #e2e8f0;
            border-radius: 0.5rem;
            background: white;
            font-size: 0.9rem;
            color: #1e293b;
            cursor: pointer;
            transition: border-color 0.3s ease;
        }
        
        .filter-select:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .clear-filters {
            background: #f1f5f9;
            color: #64748b;
            border: 1px solid #cbd5e1;
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .clear-filters:hover {
            background: #e2e8f0;
            color: #475569;
        }
        
        /* Share Button */
        .share-section {
            background: white;
            border-radius: 1rem;
            padding: 1.5rem;
            margin-bottom: 2rem;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            border: 1px solid #e2e8f0;
        }
        
        .share-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }
        
        .share-title {
            font-size: 1.2rem;
            font-weight: 700;
            color: #1e293b;
        }
        
        .share-buttons {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
        }
        
        .share-btn {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 0.75rem;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            color: white;
        }
        
        .share-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
        
        .share-btn.whatsapp {
            background: #25d366;
        }
        
        .share-btn.whatsapp:hover {
            background: #20ba5a;
        }
        
        .share-btn.email {
            background: #667eea;
        }
        
        .share-btn.email:hover {
            background: #5a67d8;
        }
        
        .share-btn.copy {
            background: #6b7280;
        }
        
        .share-btn.copy:hover {
            background: #4b5563;
        }
        
        .share-url {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 0.5rem;
            padding: 0.75rem;
            font-size: 0.9rem;
            color: #64748b;
            word-break: break-all;
            margin-top: 1rem;
        }
        
        .copy-success {
            position: fixed;
            top: 2rem;
            right: 2rem;
            background: #10b981;
            color: white;
            padding: 1rem 1.5rem;
            border-radius: 0.75rem;
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
            z-index: 1000;
            animation: slideIn 0.3s ease;
        }
        
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        .view-toggle {
            display: flex;
            gap: 0.5rem;
            background: #f1f5f9;
            padding: 0.5rem;
            border-radius: 0.75rem;
            border: 1px solid #e2e8f0;
        }
        
        .toggle-btn {
            background: transparent;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            color: #64748b;
        }
        
        .toggle-btn.active {
            background: white;
            color: #667eea;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .toggle-btn:hover:not(.active) {
            color: #475569;
        }
        
        /* File Grid */
        .file-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 1.5rem;
        }
        
        .file-card {
            background: #f8fafc;
            border-radius: 0.75rem;
            padding: 1.5rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid #e2e8f0;
        }
        
        .file-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.12);
            border-color: #667eea;
            background: white;
        }
        
        .file-preview {
            width: 80px;
            height: 80px;
            margin: 0 auto 1rem;
            border-radius: 0.5rem;
            overflow: hidden;
            background: white;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid #e2e8f0;
        }
        
        .file-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .file-icon {
            font-size: 2rem;
            color: #94a3b8;
        }
        
        .file-name {
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
            line-height: 1.3;
        }
        
        .file-date {
            color: #64748b;
            font-size: 0.8rem;
            margin-bottom: 0.75rem;
        }
        
        .file-meta {
            margin-top: 0.75rem;
            padding-top: 0.75rem;
            border-top: 1px solid #e2e8f0;
        }
        
        .file-subject {
            color: #667eea;
            font-weight: 600;
            font-size: 0.8rem;
            margin-bottom: 0.25rem;
        }
        
        .file-topic {
            color: #059669;
            font-size: 0.75rem;
            margin-bottom: 0.25rem;
        }
        
        .file-keywords {
            color: #64748b;
            font-size: 0.7rem;
        }
        
        /* Back Button */
        .back-btn {
            background: #6b7280;
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            cursor: pointer;
            font-weight: 600;
            transition: background-color 0.3s ease;
            margin-bottom: 1.5rem;
        }
        
        .back-btn:hover {
            background: #4b5563;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .header {
                padding: 1.5rem 1rem;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .language-toggle {
                position: static;
                justify-content: center;
                margin-top: 1rem;
            }
            
            .main-content {
                padding: 1rem;
            }
            
            .search-box {
                flex-direction: column;
            }
            
            .featured-content {
                grid-template-columns: 1fr;
                gap: 1.5rem;
            }
            
            .featured-actions {
                flex-direction: column;
            }
            
            .file-grid {
                grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
                gap: 1rem;
            }
            
            .share-buttons {
                flex-direction: column;
            }
            
            .share-btn {
                justify-content: center;
            }
            
            .filters-section {
                flex-direction: column;
                align-items: stretch;
            }
            
            .filter-group {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <div class="header">
            <h1>📚 Notes Dashboard</h1>
            <p>Find your study materials quickly and easily</p>
            
            <!-- Language Toggle -->
            <div class="language-toggle">
                <button id="langNl" class="lang-btn active" onclick="setLanguage('nl')">🇳🇱 NL</button>
                <button id="langEn" class="lang-btn" onclick="setLanguage('en')">🇬🇧 EN</button>
            </div>
        </div>
        
        <div class="main-content">
            <!-- Search Section -->
            <div class="search-section">
                <div class="search-box">
                    <input 
                        type="text" 
                        id="searchInput" 
                        class="search-input" 
                        placeholder="Type your name to find your notes..."
                        autocomplete="off"
                    >
                    <button id="searchBtn" class="search-btn" onclick="searchStudents()">
                        🔍 Search
                    </button>
                </div>
                
                <div id="results"></div>
            </div>
        </div>
    </div>

    <script>
        let currentResults = [];
        let currentStudent = null;
        let currentView = 'icon';
        let currentLanguage = 'nl';
        let currentFiles = [];
        let currentFilters = {
            subject: 'all',
            schoolYear: 'all'
        };
        
        // Translations
        const translations = {
            'nl': {
                'search_placeholder': 'Typ je naam om je aantekeningen te vinden...',
                'search_button': '🔍 Zoeken',
                'loading': 'Laden...',
                'no_results': 'Geen studenten gevonden',
                'try_again': 'Probeer een andere naam of controleer de spelling.',
                'students_found': 'studenten gevonden',
                'student_found': 'student gevonden',
                'last_activity': 'Laatste activiteit',
                'files': 'Bestanden',
                'click_to_view': '👆 Klik om details te bekijken',
                'back_to_search': '← Terug naar zoeken',
                'icon_view': 'Icon View',
                'list_view': 'List View',
                'no_files': 'Geen bestanden gevonden in deze map.',
                'error_loading': 'Fout bij laden van bestanden. Probeer opnieuw.',
                'error_loading_files': 'Fout bij laden',
                'hover_to_load': 'Hover om te laden',
                'latest_note': 'Laatste aantekening',
                'preview': 'Preview',
                'download': 'Download',
                'all_files': 'Alle bestanden',
                'subject': 'Vak',
                'topic': 'Onderwerp',
                'level': 'Niveau',
                'keywords': 'Trefwoorden',
                'summary': 'Samenvatting',
                'filter_subject': 'Filter op vak',
                'filter_year': 'Filter op schooljaar',
                'clear_filters': 'Filters wissen',
                'all_subjects': 'Alle vakken',
                'all_years': 'Alle schooljaren',
                'share_notes': 'Deel je aantekeningen',
                'share_whatsapp': 'Deel via WhatsApp',
                'share_email': 'Deel via e-mail',
                'copy_link': 'Kopieer link',
                'link_copied': 'Link gekopieerd!',
                'share_message': 'Bekijk mijn aantekeningen van Stephen\'s Privelessen:'
            },
            'en': {
                'search_placeholder': 'Type your name to find your notes...',
                'search_button': '🔍 Search',
                'loading': 'Loading...',
                'no_results': 'No students found',
                'try_again': 'Try a different name or check the spelling.',
                'students_found': 'students found',
                'student_found': 'student found',
                'last_activity': 'Last activity',
                'files': 'Files',
                'click_to_view': '👆 Click to view details',
                'back_to_search': '← Back to search',
                'icon_view': 'Icon View',
                'list_view': 'List View',
                'no_files': 'No files found in this folder.',
                'error_loading': 'Error loading files. Please try again.',
                'error_loading_files': 'Error loading',
                'hover_to_load': 'Hover to load',
                'latest_note': 'Latest note',
                'preview': 'Preview',
                'download': 'Download',
                'all_files': 'All files',
                'subject': 'Subject',
                'topic': 'Topic',
                'level': 'Level',
                'keywords': 'Keywords',
                'summary': 'Summary',
                'filter_subject': 'Filter by subject',
                'filter_year': 'Filter by school year',
                'clear_filters': 'Clear filters',
                'all_subjects': 'All subjects',
                'all_years': 'All school years',
                'share_notes': 'Share your notes',
                'share_whatsapp': 'Share via WhatsApp',
                'share_email': 'Share via email',
                'copy_link': 'Copy link',
                'link_copied': 'Link copied!',
                'share_message': 'Check out my notes from Stephen\'s Privelessen:'
            }
        };
        
        // Language functions
        function setLanguage(lang) {
            currentLanguage = lang;
            
            // Update active button
            document.querySelectorAll('.lang-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById('lang' + lang.charAt(0).toUpperCase() + lang.slice(1)).classList.add('active');
            
            // Update UI elements
            updateUI();
            
            // Refresh current view if student is selected
            if (currentStudent && currentFiles.length > 0) {
                // Refresh share section
                const shareSection = document.getElementById('share-section');
                if (shareSection) {
                    const shareTitle = shareSection.querySelector('.share-title');
                    const shareButtons = shareSection.querySelector('.share-buttons');
                    if (shareTitle) shareTitle.textContent = t('share_notes');
                    if (shareButtons) {
                        shareButtons.innerHTML = `
                            <button class="share-btn whatsapp" onclick="shareViaWhatsApp()">
                                📱 ${t('share_whatsapp')}
                            </button>
                            <button class="share-btn email" onclick="shareViaEmail()">
                                📧 ${t('share_email')}
                            </button>
                            <button class="share-btn copy" onclick="copyShareLink()">
                                📋 ${t('copy_link')}
                            </button>
                        `;
                    }
                }
                
                // Refresh featured note
                showFeaturedNote(currentFiles);
                
                // Refresh files display
                const filteredFiles = applyFiltersToFiles(currentFiles);
                if (currentView === 'icon') {
                    displayIconView(filteredFiles);
                } else {
                    displayListView(filteredFiles);
                }
            }
        }
        
        function updateUI() {
            const t = translations[currentLanguage];
            
            // Update search input
            const searchInput = document.getElementById('searchInput');
            if (searchInput) {
                searchInput.placeholder = t.search_placeholder;
            }
            
            // Update search button
            const searchBtn = document.getElementById('searchBtn');
            if (searchBtn && !searchBtn.disabled) {
                searchBtn.textContent = t.search_button;
            }
        }
        
        function t(key) {
            return translations[currentLanguage][key] || key;
        }
        
        // Search functionality
        function searchStudents() {
            const input = document.getElementById('searchInput');
            const searchTerm = input.value.trim();
            const resultsDiv = document.getElementById('results');
            const searchBtn = document.getElementById('searchBtn');
            
            if (!searchTerm) {
                resultsDiv.innerHTML = `<div class="error">${t('try_again')}</div>`;
                return;
            }
            
            // Show loading
            searchBtn.disabled = true;
            searchBtn.textContent = '⏳ ' + t('loading');
            resultsDiv.innerHTML = `
                <div class="loading">
                    <div class="spinner"></div>
                    <p>${t('loading')}</p>
                </div>
            `;
            
            // Call Google Apps Script function
            google.script.run
                .withSuccessHandler(displayResults)
                .withFailureHandler(showError)
                .findStudentFolders(searchTerm);
        }
        
        // Display search results
        function displayResults(matches) {
            const resultsDiv = document.getElementById('results');
            const searchBtn = document.getElementById('searchBtn');
            
            // Reset button
            searchBtn.disabled = false;
            searchBtn.textContent = t('search_button');
            
            currentResults = matches;
            
            if (matches.length === 0) {
                resultsDiv.innerHTML = `
                    <div class="no-results">
                        <h3>${t('no_results')}</h3>
                        <p>${t('try_again')}</p>
                    </div>
                `;
                return;
            }
            
            // Show stats
            const statsHtml = `
                <div class="stats">
                    ${matches.length} ${matches.length !== 1 ? t('students_found') : t('student_found')}
                </div>
            `;
            
            // Show student cards with overview info
            const studentsHtml = matches.map(student => `
                <div class="student-card" onclick="showStudentDetail('${student.id}', '${student.name}', '${student.subject}')">
                    <div class="student-header">
                        <div class="student-name">${student.name}</div>
                        <div class="subject-badge">${student.subject}</div>
                    </div>
                    <div class="student-info">
                        <div class="last-activity" id="last-activity-${student.id}">
                            📅 ${t('last_activity')}: ${t('loading')}
                        </div>
                        <div class="file-count" id="file-count-${student.id}">
                            📄 ${t('files')}: ${t('loading')}
                        </div>
                    </div>
                    <div class="click-hint">
                        ${t('click_to_view')}
                    </div>
                </div>
            `).join('');
            
            resultsDiv.innerHTML = statsHtml + studentsHtml;
            
            // Load file info for first 3 students immediately, rest on demand
            matches.slice(0, 3).forEach((student, index) => {
                setTimeout(() => {
                    loadStudentOverview(student.id);
                }, index * 200 + 100);
            });
            
            // For remaining students, show placeholder and load on hover
            matches.slice(3).forEach(student => {
                const lastActivityDiv = document.getElementById(`last-activity-${student.id}`);
                const fileCountDiv = document.getElementById(`file-count-${student.id}`);
                
                if (lastActivityDiv && fileCountDiv) {
                    lastActivityDiv.textContent = `📅 ${t('hover_to_load')}`;
                    fileCountDiv.textContent = `📄 ${t('hover_to_load')}`;
                    
                    // Add hover event to load on demand
                    const studentCard = document.querySelector(`[onclick*="${student.id}"]`);
                    if (studentCard) {
                        studentCard.addEventListener('mouseenter', () => {
                            if (lastActivityDiv.textContent.includes(t('hover_to_load'))) {
                                loadStudentOverview(student.id);
                            }
                        });
                    }
                }
            });
        }
        
        // Load student overview data
        function loadStudentOverview(folderId) {
            google.script.run
                .withSuccessHandler(overview => updateStudentOverviewFromOverview(folderId, overview))
                .withFailureHandler(error => updateStudentOverviewError(folderId, error))
                .getStudentOverview(folderId);
        }
        
        // Update student overview with file count and last activity
        function updateStudentOverviewFromOverview(folderId, overview) {
            const lastActivityDiv = document.getElementById(`last-activity-${folderId}`);
            const fileCountDiv = document.getElementById(`file-count-${folderId}`);
            
            if (!lastActivityDiv || !fileCountDiv) {
                console.error('DOM elements not found for folder:', folderId, 'retrying in 500ms...');
                setTimeout(() => {
                    updateStudentOverviewFromOverview(folderId, overview);
                }, 500);
                return;
            }
            
            if (!overview) {
                console.error('Overview is null or undefined for folder:', folderId);
                lastActivityDiv.textContent = `❌ ${t('error_loading_files')}`;
                fileCountDiv.textContent = `❌ ${t('error_loading_files')}`;
                return;
            }
            
            if (overview.fileCount > 0) {
                lastActivityDiv.textContent = `📅 ${t('last_activity')}: ${overview.lastActivityDate}`;
                fileCountDiv.textContent = `📄 ${t('files')}: ${overview.fileCount}`;
            } else {
                lastActivityDiv.textContent = `📅 Geen bestanden gevonden`;
                fileCountDiv.textContent = `📄 ${t('files')}: 0`;
            }
        }
        
        // Update student overview with error
        function updateStudentOverviewError(folderId, error) {
            const lastActivityDiv = document.getElementById(`last-activity-${folderId}`);
            const fileCountDiv = document.getElementById(`file-count-${folderId}`);
            
            if (!lastActivityDiv || !fileCountDiv) {
                console.error('DOM elements not found for error update, folder:', folderId);
                return;
            }
            
            lastActivityDiv.textContent = `❌ ${t('error_loading_files')}`;
            fileCountDiv.textContent = `❌ ${t('error_loading_files')}`;
        }
        
        // Show student detail view
        function showStudentDetail(folderId, studentName, subject) {
            currentStudent = { id: folderId, name: studentName, subject: subject };
            
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = `
                <button class="back-btn" onclick="showSearchResults()">${t('back_to_search')}</button>
                <div class="share-section" id="share-section">
                    <div class="share-header">
                        <h3 class="share-title">${t('share_notes')}</h3>
                    </div>
                    <div class="share-buttons">
                        <button class="share-btn whatsapp" onclick="shareViaWhatsApp()">
                            📱 ${t('share_whatsapp')}
                        </button>
                        <button class="share-btn email" onclick="shareViaEmail()">
                            📧 ${t('share_email')}
                        </button>
                        <button class="share-btn copy" onclick="copyShareLink()">
                            📋 ${t('copy_link')}
                        </button>
                    </div>
                    <div class="share-url" id="share-url" style="display: none;">
                        ${window.location.href}
                    </div>
                </div>
                <div class="featured-note" id="featured-note">
                    <div class="loading">
                        <div class="spinner"></div>
                        <p>${t('loading')} ${t('latest_note')}...</p>
                    </div>
                </div>
                <div class="files-section" id="files-section" style="display: none;">
                    <div class="files-header">
                        <h2 class="files-title">${t('all_files')}</h2>
                        <div class="view-toggle">
                            <button class="toggle-btn active" onclick="switchView('icon')">${t('icon_view')}</button>
                            <button class="toggle-btn" onclick="switchView('list')">${t('list_view')}</button>
                        </div>
                    </div>
                    <div class="filters-section" id="filters-section">
                        <div class="filter-group">
                            <label class="filter-label">${t('filter_subject')}</label>
                            <select class="filter-select" id="subject-filter" onchange="applyFilters()">
                                <option value="all">${t('all_subjects')}</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label class="filter-label">${t('filter_year')}</label>
                            <select class="filter-select" id="year-filter" onchange="applyFilters()">
                                <option value="all">${t('all_years')}</option>
                            </select>
                        </div>
                        <button class="clear-filters" onclick="clearFilters()">${t('clear_filters')}</button>
                    </div>
                    <div id="student-files">
                        <div class="loading">
                            <div class="spinner"></div>
                            <p>${t('loading')} ${t('files')}...</p>
                        </div>
                    </div>
                </div>
            `;
            
            // Load student files
            google.script.run
                .withSuccessHandler(files => {
                    displayFiles(folderId, files);
                    showFeaturedNote(files);
                })
                .withFailureHandler(error => {
                    console.error('Error loading files:', error);
                    document.getElementById('student-files').innerHTML = `
                        <div class="error">${t('error_loading')}</div>
                    `;
                })
                .listFilesInFolder(folderId);
        }
        
        // Show featured note (latest note)
        function showFeaturedNote(files) {
            if (!files || files.length === 0) {
                document.getElementById('featured-note').innerHTML = `
                    <div class="no-results">
                        <h3>Geen aantekeningen gevonden</h3>
                        <p>Er zijn nog geen bestanden beschikbaar voor deze student.</p>
                    </div>
                `;
                return;
            }
            
            const latestFile = files[0]; // Files are sorted by date, newest first
            
            const featuredHtml = `
                <div class="featured-header">
                    <h2 class="featured-title">${t('latest_note')}</h2>
                    <div class="featured-subject">${latestFile.subject || 'Onbekend'}</div>
                </div>
                <div class="featured-content">
                    <div class="featured-preview">
                        ${latestFile.thumbnailUrl ? 
                            `<img src="${latestFile.thumbnailUrl}" alt="Preview" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';" loading="lazy">
                             <div class="file-icon" style="display: none;">📄</div>` :
                            `<div class="file-icon">📄</div>`
                        }
                    </div>
                    <div class="featured-details">
                        <div class="featured-summary">
                            <h4>${latestFile.title || latestFile.name}</h4>
                            <p>${currentLanguage === 'en' ? (latestFile.summaryEn || latestFile.summary || 'No summary available.') : (latestFile.summary || 'Geen samenvatting beschikbaar.')}</p>
                        </div>
                        <div class="featured-meta">
                            <div class="meta-item">
                                <div class="meta-label">${t('subject')}</div>
                                <div class="meta-value">${latestFile.subject || 'Onbekend'}</div>
                            </div>
                            <div class="meta-item">
                                <div class="meta-label">${t('topic')}</div>
                                <div class="meta-value">${currentLanguage === 'en' ? (latestFile.topicEn || latestFile.topic || 'Unknown') : (latestFile.topic || 'Onbekend')}</div>
                            </div>
                            <div class="meta-item">
                                <div class="meta-label">${t('level')}</div>
                                <div class="meta-value">${latestFile.level || 'Onbekend'}</div>
                            </div>
                            ${latestFile.schoolYear ? `
                            <div class="meta-item">
                                <div class="meta-label">Schooljaar</div>
                                <div class="meta-value">${latestFile.schoolYear}</div>
                            </div>
                            ` : ''}
                        </div>
                        <div class="featured-actions">
                            <a href="${latestFile.viewUrl}" target="_blank" class="action-btn btn-primary">${t('preview')}</a>
                            <a href="${latestFile.downloadUrl}" class="action-btn btn-secondary">${t('download')}</a>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('featured-note').innerHTML = featuredHtml;
            document.getElementById('files-section').style.display = 'block';
        }
        
        // Display files
        function displayFiles(folderId, files) {
            const filesDiv = document.getElementById('student-files');
            
            if (!files || !Array.isArray(files)) {
                console.error('Files is null, undefined, or not an array for folder:', folderId, 'Files:', files);
                filesDiv.innerHTML = `<div class="error">${t('error_loading')}</div>`;
                return;
            }
            
            if (files.length === 0) {
                filesDiv.innerHTML = `<div class="no-results"><h3>${t('no_files')}</h3></div>`;
                return;
            }
            
            // Store current files for filtering
            currentFiles = files;
            
            // Populate filter options
            populateFilters(files);
            
            // Apply current filters
            const filteredFiles = applyFiltersToFiles(files);
            
            if (currentView === 'icon') {
                displayIconView(filteredFiles);
            } else {
                displayListView(filteredFiles);
            }
        }
        
        // Populate filter options
        function populateFilters(files) {
            const subjectFilter = document.getElementById('subject-filter');
            const yearFilter = document.getElementById('year-filter');
            
            // Get unique subjects
            const subjects = [...new Set(files.map(file => file.subject).filter(s => s && s !== 'Onbekend'))];
            const years = [...new Set(files.map(file => file.schoolYear).filter(y => y))];
            
            // Clear existing options (except "all")
            subjectFilter.innerHTML = `<option value="all">${t('all_subjects')}</option>`;
            yearFilter.innerHTML = `<option value="all">${t('all_years')}</option>`;
            
            // Add subject options
            subjects.forEach(subject => {
                const option = document.createElement('option');
                option.value = subject;
                option.textContent = subject;
                subjectFilter.appendChild(option);
            });
            
            // Add year options
            years.sort().reverse().forEach(year => {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                yearFilter.appendChild(option);
            });
        }
        
        // Apply filters to files
        function applyFiltersToFiles(files) {
            return files.filter(file => {
                const subjectMatch = currentFilters.subject === 'all' || file.subject === currentFilters.subject;
                const yearMatch = currentFilters.schoolYear === 'all' || file.schoolYear === currentFilters.schoolYear;
                return subjectMatch && yearMatch;
            });
        }
        
        // Apply filters
        function applyFilters() {
            const subjectFilter = document.getElementById('subject-filter');
            const yearFilter = document.getElementById('year-filter');
            
            currentFilters.subject = subjectFilter.value;
            currentFilters.schoolYear = yearFilter.value;
            
            const filteredFiles = applyFiltersToFiles(currentFiles);
            
            if (currentView === 'icon') {
                displayIconView(filteredFiles);
            } else {
                displayListView(filteredFiles);
            }
        }
        
        // Clear filters
        function clearFilters() {
            currentFilters.subject = 'all';
            currentFilters.schoolYear = 'all';
            
            const subjectFilter = document.getElementById('subject-filter');
            const yearFilter = document.getElementById('year-filter');
            
            subjectFilter.value = 'all';
            yearFilter.value = 'all';
            
            const filteredFiles = applyFiltersToFiles(currentFiles);
            
            if (currentView === 'icon') {
                displayIconView(filteredFiles);
            } else {
                displayListView(filteredFiles);
            }
        }
        
        // Display files in icon view
        function displayIconView(files) {
            const filesDiv = document.getElementById('student-files');
            
            const iconHtml = `
                <div class="file-grid">
                    ${files.map(file => {
                        const date = new Date(file.modifiedTime).toLocaleDateString('nl-NL', {
                            year: 'numeric',
                            month: 'short',
                            day: 'numeric'
                        });
                        
                        const displayTitle = file.title || file.name;
                        
                        return `
                            <div class="file-card" onclick="openFile('${file.viewUrl}', '${file.downloadUrl}')">
                                <div class="file-preview">
                                    ${file.thumbnailUrl ? 
                                        `<img src="${file.thumbnailUrl}" alt="Preview" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';" loading="lazy">
                                         <div class="file-icon" style="display: none;">📄</div>` :
                                        `<div class="file-icon">📄</div>`
                                    }
                                </div>
                                <div class="file-name">${displayTitle}</div>
                                <div class="file-date">${date}</div>
                                ${file.subject && file.subject !== 'Onbekend' ? `
                                    <div class="file-meta">
                                        <div class="file-subject">${file.subject}</div>
                                        ${file.topic ? `<div class="file-topic">${currentLanguage === 'en' ? (file.topicEn || file.topic) : file.topic}</div>` : ''}
                                        ${file.keywords && file.keywords.length > 0 ? `
                                            <div class="file-keywords">${currentLanguage === 'en' ? (file.keywordsEn || file.keywords).slice(0, 3).join(', ') : file.keywords.slice(0, 3).join(', ')}</div>
                                        ` : ''}
                                        ${file.schoolYear ? `<div class="file-year" style="font-size: 0.7rem; color: #94a3b8; margin-top: 0.25rem;">${file.schoolYear}</div>` : ''}
                                    </div>
                                ` : ''}
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
            
            filesDiv.innerHTML = iconHtml;
        }
        
        // Display files in list view
        function displayListView(files) {
            const filesDiv = document.getElementById('student-files');
            
            const listHtml = `
                <div class="file-list">
                    ${files.map(file => {
                        const date = new Date(file.modifiedTime).toLocaleDateString('nl-NL', {
                            year: 'numeric',
                            month: 'short',
                            day: 'numeric'
                        });
                        
                        const displayTitle = file.title || file.name;
                        
                        return `
                            <div class="file-card" onclick="openFile('${file.viewUrl}', '${file.downloadUrl}')">
                                <div class="file-preview">
                                    ${file.thumbnailUrl ? 
                                        `<img src="${file.thumbnailUrl}" alt="Preview" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';" loading="lazy">
                                         <div class="file-icon" style="display: none;">📄</div>` :
                                        `<div class="file-icon">📄</div>`
                                    }
                                </div>
                                <div class="file-name">${displayTitle}</div>
                                <div class="file-date">${date}</div>
                                ${file.subject && file.subject !== 'Onbekend' ? `
                                    <div class="file-meta">
                                        <div class="file-subject">${file.subject}</div>
                                        ${file.topic ? `<div class="file-topic">${currentLanguage === 'en' ? (file.topicEn || file.topic) : file.topic}</div>` : ''}
                                        ${file.keywords && file.keywords.length > 0 ? `
                                            <div class="file-keywords">${currentLanguage === 'en' ? (file.keywordsEn || file.keywords).slice(0, 3).join(', ') : file.keywords.slice(0, 3).join(', ')}</div>
                                        ` : ''}
                                        ${file.schoolYear ? `<div class="file-year" style="font-size: 0.7rem; color: #94a3b8; margin-top: 0.25rem;">${file.schoolYear}</div>` : ''}
                                    </div>
                                ` : ''}
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
            
            filesDiv.innerHTML = listHtml;
        }
        
        // Switch view between icon and list
        function switchView(view) {
            currentView = view;
            
            // Update toggle buttons
            document.querySelectorAll('.toggle-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            // Reload files with new view
            if (currentStudent) {
                google.script.run
                    .withSuccessHandler(files => displayFiles(currentStudent.id, files))
                    .withFailureHandler(error => {
                        console.error('Error reloading files:', error);
                        document.getElementById('student-files').innerHTML = `
                            <div class="error">${t('error_loading')}</div>
                        `;
                    })
                    .listFilesInFolder(currentStudent.id);
            }
        }
        
        // Open file
        function openFile(viewUrl, downloadUrl) {
            window.open(viewUrl, '_blank');
        }
        
        // Show search results again
        function showSearchResults() {
            if (currentResults && currentResults.length > 0) {
                displayResults(currentResults);
            } else {
                document.getElementById('results').innerHTML = `
                    <div class="no-results">
                        <h3>Geen zoekresultaten</h3>
                        <p>Voer een naam in om te zoeken.</p>
                    </div>
                `;
            }
        }
        
        // Share functions
        function shareViaWhatsApp() {
            const shareUrl = window.location.href;
            const message = encodeURIComponent(`${t('share_message')} ${shareUrl}`);
            const whatsappUrl = `https://wa.me/?text=${message}`;
            window.open(whatsappUrl, '_blank');
        }
        
        function shareViaEmail() {
            const shareUrl = window.location.href;
            const subject = encodeURIComponent(`${currentStudent.name} - ${t('share_notes')}`);
            const body = encodeURIComponent(`${t('share_message')}\n\n${shareUrl}`);
            const emailUrl = `mailto:?subject=${subject}&body=${body}`;
            window.location.href = emailUrl;
        }
        
        function copyShareLink() {
            const shareUrl = window.location.href;
            
            // Try to use the modern clipboard API
            if (navigator.clipboard && window.isSecureContext) {
                navigator.clipboard.writeText(shareUrl).then(() => {
                    showCopySuccess();
                }).catch(() => {
                    fallbackCopyTextToClipboard(shareUrl);
                });
            } else {
                fallbackCopyTextToClipboard(shareUrl);
            }
        }
        
        function fallbackCopyTextToClipboard(text) {
            const textArea = document.createElement("textarea");
            textArea.value = text;
            textArea.style.position = "fixed";
            textArea.style.left = "-999999px";
            textArea.style.top = "-999999px";
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            
            try {
                document.execCommand('copy');
                showCopySuccess();
            } catch (err) {
                console.error('Failed to copy text: ', err);
                alert('Failed to copy link. Please copy manually: ' + text);
            }
            
            document.body.removeChild(textArea);
        }
        
        function showCopySuccess() {
            // Remove existing success message
            const existing = document.querySelector('.copy-success');
            if (existing) {
                existing.remove();
            }
            
            // Create new success message
            const successDiv = document.createElement('div');
            successDiv.className = 'copy-success';
            successDiv.textContent = t('link_copied');
            document.body.appendChild(successDiv);
            
            // Remove after 3 seconds
            setTimeout(() => {
                if (successDiv.parentNode) {
                    successDiv.parentNode.removeChild(successDiv);
                }
            }, 3000);
        }
        
        // Show error
        function showError(error) {
            const resultsDiv = document.getElementById('results');
            const searchBtn = document.getElementById('searchBtn');
            
            searchBtn.disabled = false;
            searchBtn.textContent = t('search_button');
            
            resultsDiv.innerHTML = `
                <div class="error">
                    Er is een fout opgetreden: ${error.message || error}
                </div>
            `;
        }
        
        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            updateUI();
        });
    </script>
</body>
</html>